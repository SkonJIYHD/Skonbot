
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aterbot æ§åˆ¶é¢æ¿</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .config-section h3 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .mod-list {
            margin-top: 10px;
        }
        .mod-item {
            display: flex;
            margin-bottom: 10px;
        }
        .mod-item input {
            flex: 1;
            margin-right: 10px;
        }
        .mod-item button {
            margin-left: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            max-width: 200px;
            min-width: 150px;
        }
        .start-btn {
            background-color: #28a745;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        .save-btn {
            background-color: #007bff;
            color: white;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .status.running {
            background-color: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        .error-info {
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .character-warning {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .character-warning.error {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        }
        .message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        .message.chat { color: #28a745; }
        .message.error { color: #dc3545; background-color: #f8d7da; }
        .message.system { color: #007bff; background-color: #e7f3ff; }
        .message.server { color: #6f42c1; background-color: #f3e8ff; border-left: 3px solid #6f42c1; }
        .message.game { color: #fd7e14; background-color: #fff3e0; }
        .message.unknown { color: #6c757d; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aterbot æ§åˆ¶é¢æ¿</h1>

        <div class="config-section">
            <h3>åŸºç¡€é…ç½®</h3>
            <div class="form-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="server-address" placeholder="æœåŠ¡å™¨åœ°å€:ç«¯å£ (å¦‚: gm.rainplay.cn:25384)">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    è¾“å…¥æ ¼å¼: æœåŠ¡å™¨åœ°å€:ç«¯å£ï¼Œå¦‚æœä¸å¡«ç«¯å£é»˜è®¤ä½¿ç”¨25565
                </div>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="username" placeholder="æœºå™¨äººç”¨æˆ·å">
                <div style="margin-top: 5px;">
                    <button type="button" onclick="suggestUsername()" style="background-color: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px;">ğŸ² éšæœºæ¨èç”¨æˆ·å</button>
                    <small style="margin-left: 10px; color: #666;">å¦‚æœå½“å‰ç”¨æˆ·åè¢«è¸¢å‡ºï¼Œå¯ä»¥å°è¯•å…¶ä»–åå­—å–µ</small>
                </div>
                <div id="username-warning" class="character-warning" style="display: none; margin-top: 5px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;">
                    <strong>âš ï¸ ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦ï¼</strong><br>
                    MinecraftæœåŠ¡å™¨é€šå¸¸åªå…è®¸å­—æ¯(a-z, A-Z)å’Œæ•°å­—(0-9)ï¼Œä¸æ”¯æŒä¸‹åˆ’çº¿(_)ã€ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦å·ã€‚<br>
                    å»ºè®®ä½¿ç”¨çº¯å­—æ¯æ•°å­—ç»„åˆï¼Œå¦‚: BotSkon, AterBot123
                </div>
            </div>
            <div class="form-group">
                <label>æ¸¸æˆç‰ˆæœ¬:</label>
                <select id="java-version">
                    <option value="1.21.1">1.21.1</option>
                    <option value="1.21">1.21</option>
                    <option value="1.20.6">1.20.6</option>
                    <option value="1.20.4">1.20.4</option>
                    <option value="1.20.1">1.20.1</option>
                    <option value="1.19.4">1.19.4</option>
                    <option value="1.18.2">1.18.2</option>
                </select>
            </div>
            <div class="form-group">
                <label>è®¤è¯æ–¹å¼:</label>
                <select id="auth" disabled>
                    <option value="offline">ç¦»çº¿æ¨¡å¼ (æœºå™¨äººä»…æ”¯æŒæ­¤æ¨¡å¼)</option>
                </select>
                <div style="margin-top: 5px; padding: 6px; background-color: #e7f3ff; border: 1px solid #b8daff; border-radius: 4px; font-size: 12px; color: #004085;">
                    <strong>ğŸ’¡ æç¤º:</strong> æœºå™¨äººåªèƒ½ä½¿ç”¨ç¦»çº¿æ¨¡å¼è¿æ¥æœåŠ¡å™¨ï¼Œä¸æ”¯æŒæ­£ç‰ˆéªŒè¯ã€‚
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ¨ çš®è‚¤é…ç½®</h3>
            <div class="form-group">
                <label>çš®è‚¤æ¨¡å¼:</label>
                <select id="skinMode" onchange="updateSkinMode()">
                    <option value="default">é»˜è®¤çš®è‚¤ (Steve)</option>
                    <option value="url">è‡ªå®šä¹‰çš®è‚¤URL</option>
                    <option value="yggdrasil">ç¬¬ä¸‰æ–¹çš®è‚¤ç«™ (Yggdrasil)</option>
                    <option value="littleskin">LittleSkinçš®è‚¤ç«™</option>
                </select>
            </div>

            <div id="skin-url-section" class="form-group" style="display: none;">
                <label>çš®è‚¤URL:</label>
                <input type="url" id="skinUrl" placeholder="https://example.com/skin.png">
            </div>

            <div id="yggdrasil-section" style="display: none;">
                <div class="form-group">
                    <label>YggdrasilæœåŠ¡å™¨:</label>
                    <select id="skinServer" onchange="updateYggdrasilUrl()">
                        <option value="https://littleskin.cn/api/yggdrasil">LittleSkin</option>
                        <option value="https://auth.mc-user.com:233">ç»Ÿä¸€é€šè¡Œè¯</option>
                        <option value="custom">è‡ªå®šä¹‰æœåŠ¡å™¨</option>
                    </select>
                </div>
                <div id="custom-yggdrasil" class="form-group" style="display: none;">
                    <label>è‡ªå®šä¹‰Yggdrasil URL:</label>
                    <input type="url" id="customYggdrasilUrl" placeholder="https://your-server.com/api/yggdrasil">
                </div>
                <div class="form-group">
                    <label>çš®è‚¤ç«™ç”¨æˆ·å:</label>
                    <input type="text" id="yggdrasilUsername" placeholder="åœ¨çš®è‚¤ç«™çš„ç”¨æˆ·å">
                </div>
            </div>

            <div id="littleskin-section" style="display: none;">
                <div class="form-group">
                    <label>LittleSkinç”¨æˆ·å:</label>
                    <input type="text" id="littleskinUsername" placeholder="LittleSkinç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enableLittleskinAuth" onchange="updateLittleskinAuth()" style="margin-right: 8px;"> 
                        å¯ç”¨LittleSkinè®¤è¯
                    </label>
                </div>
                <div id="littleskin-auth-section" class="form-group" style="display: none;">
                    <label>LittleSkinå¯†ç :</label>
                    <input type="password" id="littleskinPassword" placeholder="LittleSkinè´¦æˆ·å¯†ç ">
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ”§ æ¨¡ç»„é…ç½®</h3>
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="adaptive-mods" onchange="updateAdaptiveMode()" style="margin-right: 8px;"> 
                    å¯ç”¨è‡ªé€‚åº”modæ¨¡å¼
                </label>
                <div style="margin: 8px 0; padding: 8px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px;">
                    <strong>ğŸ”¥ è‡ªé€‚åº”æ¨¡å¼:</strong> æœºå™¨äººä¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨è¦æ±‚çš„modåˆ—è¡¨ï¼Œç„¶åä¼ªè£…æˆæ‹¥æœ‰è¿™äº›modï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å–µï¼
                </div>
            </div>
            <div id="manual-mods-section">
                <div class="form-group">
                    <label>æ‰‹åŠ¨æ·»åŠ modåˆ—è¡¨:</label>
                    <div style="margin: 8px 0; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px;">
                        <strong>ğŸ“ æ‰‹åŠ¨æ¨¡å¼:</strong> åœ¨å…³é—­è‡ªé€‚åº”æ¨¡å¼æ—¶ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æ·»åŠ æœåŠ¡å™¨éœ€è¦çš„modåç§°ã€‚å¸¸è§çš„modå¦‚ï¼šforgeã€optifineã€jeiã€journeymapç­‰ã€‚
                    </div>
                    <div id="mod-list" class="mod-list"></div>
                    <div style="margin-top: 10px;">
                        <button type="button" onclick="addMod()" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px;">â• æ·»åŠ mod</button>
                        <button type="button" onclick="addCommonMods()" style="background-color: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px;">ğŸ¯ æ·»åŠ å¸¸ç”¨mod</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ® æœºå™¨äººæ§åˆ¶é¢æ¿</h3>
            <div class="control-buttons">
                <button class="save-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button id="toggle-btn" class="start-btn" onclick="toggleBot()">â–¶ï¸ å¯åŠ¨æœºå™¨äºº</button>
            </div>
            <div id="status" class="status stopped">æœºå™¨äººçŠ¶æ€: å·²åœæ­¢</div>
        </div>

        <div id="error-info" class="error-info hidden"></div>

        <div class="config-section" id="command-section" style="display: none;">
            <h3>ğŸ® æœºå™¨äººå‘½ä»¤æ§åˆ¶</h3>
            <div class="form-group">
                <label>æ‰§è¡ŒMinecraftå‘½ä»¤:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="minecraft-command" placeholder="è¾“å…¥å‘½ä»¤ (å¦‚: /time set day)" style="flex: 1;">
                    <button onclick="executeMinecraftCommand()" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px;">æ‰§è¡Œ</button>
                </div>
            </div>

            <div class="form-group">
                <label>å‘é€èŠå¤©æ¶ˆæ¯:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯" style="flex: 1;">
                    <button onclick="sendChatMessage()" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px;">å‘é€</button>
                </div>
            </div>

            <div class="form-group">
                <label>æœåŠ¡å™¨æ¶ˆæ¯ç›‘æ§:</label>
                <div id="server-messages" style="height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f0f8ff; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 10px;">
                    <!-- æœåŠ¡å™¨æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <button onclick="clearServerMessages()" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 10px;">æ¸…é™¤æ¶ˆæ¯</button>
                <button onclick="toggleAutoScroll()" id="auto-scroll-btn" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px;">è‡ªåŠ¨æ»šåŠ¨: å¼€</button>
            </div>

            <div class="form-group">
                <label>ğŸ“‹ æŒ‡ä»¤æ‰§è¡Œæ—¥å¿—:</label>
                <div id="command-logs" style="height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f8ff; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 10px;">
                    <!-- æŒ‡ä»¤æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <button onclick="clearCommandLogs()" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 10px;">æ¸…é™¤æ—¥å¿—</button>
                <button onclick="exportCommandLogs()" style="background-color: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px;">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let mods = [];
        let eventSource = null;
        let autoScroll = true;
        let commandLogs = [];
        let maxCommandLogs = 100;

        // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰é…ç½®
        window.onload = function() {
            loadConfig();
            updateStatus();
            setInterval(updateStatus, 2000);
        };

        function parseServerAddress(input) {
            const value = input.value.trim();
            if (!value) return;

            if (value.includes(':')) {
                const parts = value.split(':');
                if (parts.length === 2) {
                    const host = parts[0].trim();
                    const port = parts[1].trim();

                    if (port && !/^\d+$/.test(port)) {
                        input.style.borderColor = '#dc3545';
                        input.title = 'ç«¯å£å¿…é¡»æ˜¯æ•°å­—å–µï¼';
                    } else if (port && (parseInt(port) < 1 || parseInt(port) > 65535)) {
                        input.style.borderColor = '#dc3545';
                        input.title = 'ç«¯å£èŒƒå›´å¿…é¡»åœ¨1-65535ä¹‹é—´å–µï¼';
                    } else {
                        input.style.borderColor = '#28a745';
                        input.title = `æœåŠ¡å™¨: ${host}ï¼Œç«¯å£: ${port || '25565'}`;
                    }
                }
            } else {
                input.style.borderColor = '#17a2b8';
                input.title = `æœåŠ¡å™¨: ${value}ï¼Œç«¯å£: 25565 (é»˜è®¤)`;
            }
        }

        function validateUsername(input) {
            const username = input.value;
            const warningEl = document.getElementById('username-warning');

            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (illegalChars && illegalChars.length > 0) {
                const uniqueChars = [...new Set(illegalChars)];
                const suggestionName = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                warningEl.innerHTML = `
                    <strong>ğŸš« ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦: ${uniqueChars.join(', ')}</strong><br>
                    <strong>ğŸ’¡ å»ºè®®ä¿®æ”¹ä¸º:</strong> <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">${suggestionName}</code><br>
                    <small>åªå…è®¸ä½¿ç”¨å­—æ¯(a-z, A-Z)å’Œæ•°å­—(0-9)ï¼Œä¸æ”¯æŒä¸‹åˆ’çº¿ã€ç©ºæ ¼ã€ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦å–µ~</small>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length > 16) {
                warningEl.innerHTML = `
                    <strong>ğŸ“ ç”¨æˆ·åè¿‡é•¿ï¼</strong><br>
                    Minecraftç”¨æˆ·åé™åˆ¶ä¸ºæœ€å¤š16ä¸ªå­—ç¬¦ï¼Œå½“å‰é•¿åº¦: ${username.length} ä¸ªå­—ç¬¦<br>
                    <strong>å»ºè®®ç¼©çŸ­ä¸º:</strong> <code>${username.substring(0, 16)}</code>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length >= 3) {
                warningEl.innerHTML = `
                    <strong>âœ… ç”¨æˆ·åæ ¼å¼å®Œå…¨æ­£ç¡®å–µï¼</strong><br>
                    æœºå™¨äººå¯ä»¥æ­£å¸¸ä½¿ç”¨æ­¤ç”¨æˆ·åè¿›å…¥æœåŠ¡å™¨å–µ~
                `;
                warningEl.className = 'character-warning';
                warningEl.style.display = 'block';
                warningEl.style.backgroundColor = '#d1ecf1';
                warningEl.style.borderColor = '#bee5eb';
                warningEl.style.color = '#0c5460';
            } else {
                warningEl.style.display = 'none';
            }
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    config = data;
                    updateUI();
                })
                .catch(error => console.error('åŠ è½½é…ç½®å¤±è´¥:', error));
        }

        function updateUI() {
            const host = config.client?.host || '';
            const port = config.client?.port || '';
            const serverAddress = host && port ? `${host}:${port}` : (host || '');

            document.getElementById('server-address').value = serverAddress;
            document.getElementById('username').value = config.client?.username || '';
            document.getElementById('java-version').value = config.client?.version || '1.21.1';
            document.getElementById('auth').value = config.client?.auth || 'offline';

            mods = config.client?.mods || [];
            updateModList();

            document.getElementById('adaptive-mods').checked = config.client?.adaptiveMods || false;
            updateAdaptiveMode();

            if (config.client?.skinMode) {
                document.getElementById('skinMode').value = config.client.skinMode;
                updateSkinMode();
            }
            if (config.client?.skinUrl) {
                document.getElementById('skinUrl').value = config.client.skinUrl;
            }
            if (config.client?.yggdrasilServer) {
                const serverSelect = document.getElementById('skinServer');
                if ([...serverSelect.options].some(option => option.value === config.client.yggdrasilServer)) {
                    serverSelect.value = config.client.yggdrasilServer;
                } else {
                    serverSelect.value = 'custom';
                    document.getElementById('customYggdrasilUrl').value = config.client.yggdrasilServer;
                }
                updateYggdrasilUrl();
            }
            if (config.client?.yggdrasilUsername) {
                document.getElementById('yggdrasilUsername').value = config.client.yggdrasilUsername;
            }
            if (config.client?.littleskinUsername) {
                document.getElementById('littleskinUsername').value = config.client.littleskinUsername;
            }
            if (config.client?.littleskinPassword) {
                document.getElementById('littleskinPassword').value = config.client.littleskinPassword;
            }
            if (config.client?.enableLittleskinAuth !== undefined) {
                document.getElementById('enableLittleskinAuth').checked = config.client.enableLittleskinAuth;
                updateLittleskinAuth();
            }
        }

        function updateSkinMode() {
            const skinMode = document.getElementById('skinMode').value;
            const skinUrlSection = document.getElementById('skin-url-section');
            const yggdrasilSection = document.getElementById('yggdrasil-section');
            const littleskinSection = document.getElementById('littleskin-section');

            skinUrlSection.style.display = 'none';
            yggdrasilSection.style.display = 'none';
            littleskinSection.style.display = 'none';

            if (skinMode === 'url') {
                skinUrlSection.style.display = 'block';
            } else if (skinMode === 'yggdrasil') {
                yggdrasilSection.style.display = 'block';
            } else if (skinMode === 'littleskin') {
                littleskinSection.style.display = 'block';
            }
        }

        function updateYggdrasilUrl() {
            const serverSelect = document.getElementById('skinServer');
            const customSection = document.getElementById('custom-yggdrasil');

            if (serverSelect.value === 'custom') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
            }
        }

        function updateLittleskinAuth() {
            const enableAuth = document.getElementById('enableLittleskinAuth').checked;
            const authSection = document.getElementById('littleskin-auth-section');

            if (enableAuth) {
                authSection.style.display = 'block';
            } else {
                authSection.style.display = 'none';
            }
        }

        function updateAdaptiveMode() {
            const isAdaptive = document.getElementById('adaptive-mods').checked;
            const manualSection = document.getElementById('manual-mods-section');

            if (isAdaptive) {
                manualSection.style.opacity = '0.5';
                manualSection.style.pointerEvents = 'none';
            } else {
                manualSection.style.opacity = '1';
                manualSection.style.pointerEvents = 'auto';
            }
        }

        function addMod() {
            mods.push('');
            updateModList();
        }

        function removeMod(index) {
            mods.splice(index, 1);
            updateModList();
        }

        function updateModList() {
            const modListEl = document.getElementById('mod-list');
            modListEl.innerHTML = '';

            mods.forEach((mod, index) => {
                const modItem = document.createElement('div');
                modItem.className = 'mod-item';
                modItem.innerHTML = `
                    <input type="text" value="${mod}" placeholder="modåç§° (å¦‚: forge, optifine, jei)" 
                           onchange="mods[${index}] = this.value">
                    <button onclick="removeMod(${index})">åˆ é™¤</button>
                `;
                modListEl.appendChild(modItem);
            });
        }

        function addCommonMods() {
            const commonMods = ['forge', 'optifine', 'jei', 'journeymap', 'waila'];
            const selectedMods = prompt('é€‰æ‹©è¦æ·»åŠ çš„å¸¸ç”¨mod (ç”¨é€—å·åˆ†éš”):\n' + commonMods.join(', '));

            if (selectedMods) {
                const modsToAdd = selectedMods.split(',').map(m => m.trim()).filter(m => m);
                modsToAdd.forEach(mod => {
                    if (!mods.includes(mod)) {
                        mods.push(mod);
                    }
                });
                updateModList();
            }
        }

        function saveConfig() {
            const username = document.getElementById('username').value;
            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (!username.trim()) {
                alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºå–µï¼');
                return;
            }

            if (illegalChars && illegalChars.length > 0) {
                const suggestion = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                alert(`ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦: ${[...new Set(illegalChars)].join(', ')}\nå»ºè®®ä¿®æ”¹ä¸º: ${suggestion}`);
                return;
            }

            const serverAddress = document.getElementById('server-address').value.trim();
            let host = '';
            let port = '';

            if (serverAddress.includes(':')) {
                const parts = serverAddress.split(':');
                host = parts[0].trim();
                port = parts[1].trim();
            } else {
                host = serverAddress;
                port = '25565';
            }

            const newConfig = {
                ...config,
                client: {
                    ...config.client,
                    host: host,
                    port: port,
                    username: username,
                    version: document.getElementById('java-version').value,
                    auth: 'offline',
                    adaptiveMods: document.getElementById('adaptive-mods').checked,
                    mods: mods.filter(mod => mod.trim() !== ''),
                    skinMode: document.getElementById('skinMode').value,
                    skinUrl: document.getElementById('skinUrl').value || null
                }
            };

            const skinMode = document.getElementById('skinMode').value;

            if (skinMode === 'yggdrasil') {
                const skinServer = document.getElementById('skinServer').value;
                const customUrl = document.getElementById('customYggdrasilUrl').value;
                const yggdrasilUsername = document.getElementById('yggdrasilUsername').value;

                newConfig.client.yggdrasilServer = skinServer === 'custom' ? customUrl : skinServer;
                newConfig.client.yggdrasilUsername = yggdrasilUsername;
            }

            if (skinMode === 'littleskin') {
                const littleskinUsername = document.getElementById('littleskinUsername').value;
                const enableLittleskinAuth = document.getElementById('enableLittleskinAuth').checked;
                const littleskinPassword = document.getElementById('littleskinPassword').value;

                newConfig.client.littleskinUsername = littleskinUsername;
                newConfig.client.enableLittleskinAuth = enableLittleskinAuth;
                if (enableLittleskinAuth && littleskinPassword) {
                    newConfig.client.littleskinPassword = littleskinPassword;
                }
            }

            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
                    config = newConfig;
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜é…ç½®å¤±è´¥');
            });
        }

        function toggleBot() {
            const statusEl = document.getElementById('status');
            if (statusEl.className === 'status running') {
                stopBot();
            } else {
                startBot();
            }
        }

        function startBot() {
            document.getElementById('error-info').className = 'error-info hidden';

            fetch('/api/bot/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æœºå™¨äººå¯åŠ¨æˆåŠŸï¼');
                        setTimeout(updateStatus, 1000);
                    } else {
                        alert('å¯åŠ¨å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('å¯åŠ¨æœºå™¨äººå¤±è´¥:', error);
                    alert('å¯åŠ¨æœºå™¨äººå¤±è´¥');
                });
        }

        function stopBot() {
            fetch('/api/bot/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æœºå™¨äººå·²åœæ­¢ï¼');
                        setTimeout(() => {
                            updateStatus();
                        }, 500);
                    } else {
                        alert('åœæ­¢å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åœæ­¢æœºå™¨äººå¤±è´¥:', error);
                    alert('åœæ­¢æœºå™¨äººå¤±è´¥');
                });
        }

        function updateToggleButton(isRunning) {
            const toggleBtn = document.getElementById('toggle-btn');
            if (isRunning) {
                toggleBtn.textContent = 'â¹ï¸ åœæ­¢æœºå™¨äºº';
                toggleBtn.className = 'stop-btn';
            } else {
                toggleBtn.textContent = 'â–¶ï¸ å¯åŠ¨æœºå™¨äºº';
                toggleBtn.className = 'start-btn';
            }
        }

        let statusCheckErrors = 0;
        const maxStatusErrors = 3;

        function updateStatus() {
            fetch('/api/bot/status')
                .then(response => response.json())
                .then(data => {
                    // çŠ¶æ€æ£€æŸ¥æˆåŠŸï¼Œé‡ç½®é”™è¯¯è®¡æ•°
                    statusCheckErrors = 0;

                    const statusEl = document.getElementById('status');
                    const errorEl = document.getElementById('error-info');
                    const commandSection = document.getElementById('command-section');

                    if (data.running) {
                        statusEl.textContent = 'æœºå™¨äººçŠ¶æ€: è¿è¡Œä¸­';
                        statusEl.className = 'status running';
                        errorEl.className = 'error-info hidden';
                        commandSection.style.display = 'block';
                        updateToggleButton(true);

                        if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                            connectToMessageStream();
                        }
                    } else {
                        statusEl.textContent = 'æœºå™¨äººçŠ¶æ€: å·²åœæ­¢';
                        statusEl.className = 'status stopped';
                        commandSection.style.display = 'none';
                        updateToggleButton(false);

                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }

                        if (data.error) {
                            errorEl.innerHTML = '<h4>ğŸš¨ å¯åŠ¨å¤±è´¥åŸå› :</h4>' + data.error;
                            errorEl.className = 'error-info';
                        } else {
                            errorEl.className = 'error-info hidden';
                        }
                    }
                })
                .catch(error => {
                    statusCheckErrors++;
                    
                    // åªåœ¨å‰å‡ æ¬¡é”™è¯¯æ—¶æ˜¾ç¤ºæ—¥å¿—
                    if (statusCheckErrors <= maxStatusErrors) {
                        console.error(`è·å–çŠ¶æ€å¤±è´¥ (${statusCheckErrors}/${maxStatusErrors}):`, error);
                    }
                    
                    // å¦‚æœé”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œæ˜¾ç¤ºç¦»çº¿çŠ¶æ€
                    if (statusCheckErrors > maxStatusErrors) {
                        const statusEl = document.getElementById('status');
                        statusEl.textContent = 'æœºå™¨äººçŠ¶æ€: è¿æ¥æœåŠ¡å™¨å¤±è´¥';
                        statusEl.className = 'status stopped';
                        statusEl.style.backgroundColor = '#f8d7da';
                        statusEl.style.color = '#721c24';
                    }
                });
        }

        function executeMinecraftCommand() {
            const command = document.getElementById('minecraft-command').value.trim();
            if (!command) {
                alert('è¯·è¾“å…¥å‘½ä»¤å–µï¼');
                return;
            }

            const fullCommand = command.startsWith('/') ? command : '/' + command;
            const timestamp = new Date().toISOString();

            // è®°å½•å‘½ä»¤åˆ°æ—¥å¿—
            addCommandLog(`ğŸ“¤ æ‰§è¡Œå‘½ä»¤: ${fullCommand}`, timestamp, 'command');

            fetch('/api/bot/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: fullCommand })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`âœ… å‘½ä»¤æ‰§è¡Œ: ${fullCommand}`);
                    addCommandLog(`âœ… å‘½ä»¤å·²å‘é€: ${fullCommand}`, new Date().toISOString(), 'success');
                    document.getElementById('minecraft-command').value = '';
                } else {
                    console.log(`âŒ å‘½ä»¤å¤±è´¥: ${fullCommand} - ${data.message}`);
                    addCommandLog(`âŒ å‘½ä»¤å¤±è´¥: ${fullCommand} - ${data.message}`, new Date().toISOString(), 'error');
                }
            })
            .catch(error => {
                console.log(`âŒ ç½‘ç»œé”™è¯¯: ${fullCommand} - ${error.message}`);
                addCommandLog(`âŒ ç½‘ç»œé”™è¯¯: ${fullCommand} - ${error.message}`, new Date().toISOString(), 'error');
            });
        }

        function sendChatMessage() {
            const message = document.getElementById('chat-message').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å–µï¼');
                return;
            }

            const timestamp = new Date().toISOString();
            // è®°å½•èŠå¤©åˆ°æ—¥å¿—
            addCommandLog(`ğŸ’¬ å‘é€èŠå¤©: ${message}`, timestamp, 'chat');

            fetch('/api/bot/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`ğŸ’¬ èŠå¤©å‘é€: ${message}`);
                    addCommandLog(`âœ… èŠå¤©å·²å‘é€: ${message}`, new Date().toISOString(), 'success');
                    document.getElementById('chat-message').value = '';
                } else {
                    console.log(`âŒ èŠå¤©å¤±è´¥: ${message} - ${data.message}`);
                    addCommandLog(`âŒ èŠå¤©å¤±è´¥: ${message} - ${data.message}`, new Date().toISOString(), 'error');
                }
            })
            .catch(error => {
                console.log(`âŒ ç½‘ç»œé”™è¯¯: ${message} - ${error.message}`);
                addCommandLog(`âŒ ç½‘ç»œé”™è¯¯: ${message} - ${error.message}`, new Date().toISOString(), 'error');
            });
        }

        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let reconnectTimeout = null;

        function connectToMessageStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            // å‡å°‘æ§åˆ¶å°æ—¥å¿—è¾“å‡º
            if (reconnectAttempts === 0) {
                console.log('ğŸ”— æ­£åœ¨è¿æ¥åˆ°æ¶ˆæ¯æµ...');
            }

            try {
                eventSource = new EventSource('/api/events');

                eventSource.onopen = function(event) {
                    // è¿æ¥æˆåŠŸï¼Œé‡ç½®é‡è¿è®¡æ•°å™¨
                    reconnectAttempts = 0;
                    if (reconnectTimeout) {
                        clearTimeout(reconnectTimeout);
                        reconnectTimeout = null;
                    }
                    console.log('âœ… æ¶ˆæ¯æµè¿æ¥æˆåŠŸ');
                };

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // éªŒè¯æ•°æ®å®Œæ•´æ€§
                        if (data && data.message !== undefined && data.message !== null) {
                            addServerMessage(data.message, data.timestamp, data.type);
                        } else {
                            console.log('âš ï¸ æ”¶åˆ°æ— æ•ˆæ¶ˆæ¯æ•°æ®:', data);
                        }
                    } catch (error) {
                        // å‡å°‘é”™è¯¯æ—¥å¿—è¾“å‡º
                        if (reconnectAttempts < 3) {
                            console.error('âŒ è§£ææ¶ˆæ¯å¤±è´¥:', error, 'åŸå§‹æ•°æ®:', event.data);
                        }
                    }
                };

                eventSource.onerror = function(error) {
                    // é¿å…é‡å¤çš„é”™è¯¯æ—¥å¿—
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        
                        // åªåœ¨å‰å‡ æ¬¡å°è¯•æ—¶æ˜¾ç¤ºé”™è¯¯
                        if (reconnectAttempts <= 2) {
                            console.error(`ğŸ’¥ æ¶ˆæ¯æµè¿æ¥é”™è¯¯ (${reconnectAttempts}/${maxReconnectAttempts}):`, error);
                        }

                        // æ¸…é™¤ä¹‹å‰çš„é‡è¿å®šæ—¶å™¨
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                        }

                        // æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 10000);
                        
                        reconnectTimeout = setTimeout(() => {
                            if (document.getElementById('status').className === 'status running') {
                                connectToMessageStream();
                            }
                        }, delay);
                    } else {
                        console.error('âŒ SSEè¿æ¥å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œåœæ­¢é‡è¿');
                        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€åœ¨UIä¸Š
                        const messagesEl = document.getElementById('server-messages');
                        if (messagesEl) {
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'color: #dc3545; font-weight: bold; padding: 10px; border: 1px solid #dc3545; border-radius: 4px; margin: 5px 0;';
                            errorDiv.textContent = 'âš ï¸ æ¶ˆæ¯æµè¿æ¥å¤±è´¥ï¼Œè¯·é‡å¯æœºå™¨äººé‡æ–°è¿æ¥';
                            messagesEl.appendChild(errorDiv);
                        }
                    }
                };

            } catch (error) {
                if (reconnectAttempts < 2) {
                    console.error('ğŸ’¥ åˆ›å»ºæ¶ˆæ¯æµè¿æ¥å¤±è´¥:', error);
                }
            }
        }

        function addServerMessage(message, timestamp, messageType) {
            const messagesEl = document.getElementById('server-messages');
            if (!messagesEl) return;

            // éªŒè¯æ¶ˆæ¯ä¸ä¸ºç©ºæˆ–undefined
            if (!message || message === 'undefined' || message.trim() === '') {
                console.log('âš ï¸ æ”¶åˆ°ç©ºæ¶ˆæ¯ï¼Œè·³è¿‡æ˜¾ç¤º');
                return;
            }

            const time = new Date(timestamp).toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 3px; padding: 8px; border-radius: 4px; border-left: 3px solid #ddd; background-color: #f8f9fa;';
            messageDiv.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">[${time}]</div>
                <div style="font-family: 'Courier New', monospace; font-size: 13px;">ğŸ’¬ ${message}</div>
            `;

            messagesEl.appendChild(messageDiv);

            // æ£€æŸ¥æ˜¯å¦æ˜¯å‘½ä»¤ç›¸å…³çš„æœåŠ¡å™¨å“åº”ï¼Œå¦‚æœæ˜¯åˆ™ä¹Ÿè®°å½•åˆ°æŒ‡ä»¤æ—¥å¿—
            const isCommandResponse = message.includes('ç§å­') || 
                                     message.includes('Seed') || 
                                     message.includes('seed:') ||
                                     message.includes('åœ¨çº¿ç©å®¶') || 
                                     message.includes('players online') ||
                                     message.includes('There are') ||
                                     message.includes('å½“å‰æœ‰') ||
                                     message.includes('list:') ||
                                     message.includes('gamemode') ||
                                     message.includes('æ¨¡å¼') ||
                                     message.includes('tp') ||
                                     message.includes('ä¼ é€') ||
                                     message.includes('time') ||
                                     message.includes('æ—¶é—´') ||
                                     message.includes('weather') ||
                                     message.includes('å¤©æ°”') ||
                                     message.includes('Unknown command') ||
                                     message.includes('æœªçŸ¥å‘½ä»¤') ||
                                     message.includes('æƒé™') ||
                                     message.includes('permission');

            if (isCommandResponse) {
                addCommandLog(`ğŸ“¥ æœåŠ¡å™¨å“åº”: ${message}`, timestamp, 'response');
            }

            if (autoScroll) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            while (messagesEl.children.length > 200) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        function clearServerMessages() {
            document.getElementById('server-messages').innerHTML = '';
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('auto-scroll-btn');
            btn.textContent = `è‡ªåŠ¨æ»šåŠ¨: ${autoScroll ? 'å¼€' : 'å…³'}`;
            btn.style.backgroundColor = autoScroll ? '#28a745' : '#6c757d';
        }

        function addCommandLog(message, timestamp, logType) {
            const time = new Date(timestamp).toLocaleTimeString();
            const logEntry = {
                message: message,
                timestamp: timestamp,
                type: logType,
                time: time
            };

            commandLogs.push(logEntry);

            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (commandLogs.length > maxCommandLogs) {
                commandLogs = commandLogs.slice(-maxCommandLogs);
            }

            updateCommandLogDisplay();
        }

        function updateCommandLogDisplay() {
            const logsEl = document.getElementById('command-logs');
            if (!logsEl) return;

            // åªæ˜¾ç¤ºæœ€è¿‘çš„æ—¥å¿—æ¡ç›®ï¼Œé¿å…DOMè¿‡å¤§
            const displayLogs = commandLogs.slice(-50);
            logsEl.innerHTML = '';

            displayLogs.forEach(log => {
                const logDiv = document.createElement('div');
                let bgColor = '#f8f9fa';
                let borderColor = '#ddd';
                let textColor = '#333';

                switch (log.type) {
                    case 'command':
                        bgColor = '#fff3e0';
                        borderColor = '#ff9800';
                        textColor = '#e65100';
                        break;
                    case 'chat':
                        bgColor = '#e8f5e8';
                        borderColor = '#4caf50';
                        textColor = '#2e7d32';
                        break;
                    case 'success':
                        bgColor = '#e8f5e8';
                        borderColor = '#4caf50';
                        textColor = '#2e7d32';
                        break;
                    case 'error':
                        bgColor = '#ffebee';
                        borderColor = '#f44336';
                        textColor = '#c62828';
                        break;
                    case 'response':
                        bgColor = '#e3f2fd';
                        borderColor = '#2196f3';
                        textColor = '#1565c0';
                        break;
                }

                logDiv.style.cssText = `
                    margin-bottom: 3px; 
                    padding: 6px; 
                    border-radius: 4px; 
                    border-left: 3px solid ${borderColor}; 
                    background-color: ${bgColor};
                    color: ${textColor};
                `;

                logDiv.innerHTML = `
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px;">[${log.time}]</div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px;">${log.message}</div>
                `;

                logsEl.appendChild(logDiv);
            });

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function clearCommandLogs() {
            commandLogs = [];
            document.getElementById('command-logs').innerHTML = '';
            addCommandLog('ğŸ“‹ æŒ‡ä»¤æ—¥å¿—å·²æ¸…é™¤', new Date().toISOString(), 'success');
        }

        function exportCommandLogs() {
            if (commandLogs.length === 0) {
                alert('æ²¡æœ‰æ—¥å¿—å¯ä»¥å¯¼å‡ºå–µï¼');
                return;
            }

            const logText = commandLogs.map(log => {
                return `[${new Date(log.timestamp).toLocaleString()}] ${log.message}`;
            }).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aterbot-å‘½ä»¤æ—¥å¿—-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addCommandLog(`ğŸ“ å·²å¯¼å‡º ${commandLogs.length} æ¡æ—¥å¿—è®°å½•`, new Date().toISOString(), 'success');
        }

        function suggestUsername() {
            const simpleNames = ['BotSkon', 'AterBot', 'AutoBot', 'HelperBot', 'TestBot', 'PlayerBot', 'GameBot', 'MCBot'];
            const suggestedName = simpleNames[Math.floor(Math.random() * simpleNames.length)];

            document.getElementById('username').value = suggestedName;

            alert(`ğŸ’¡ æ¨èç”¨æˆ·å: ${suggestedName}\n\nè¿™ä¸ªåå­—å®Œå…¨ç¬¦åˆMinecraftæœåŠ¡å™¨è¦æ±‚ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å–µï¼`);
        }

        // å›è½¦é”®å¿«æ·æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('minecraft-command').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeMinecraftCommand();
                }
            });

            document.getElementById('chat-message').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('server-address').addEventListener('input', function() {
                parseServerAddress(this);
            });

            document.getElementById('username').addEventListener('input', function() {
                validateUsername(this);
            });
        });
    </script>
</body>
</html>
