<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aterbot æ§åˆ¶é¢æ¿</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .config-section h3 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .mod-list {
            margin-top: 10px;
        }
        .mod-item {
            display: flex;
            margin-bottom: 10px;
        }
        .mod-item input {
            flex: 1;
            margin-right: 10px;
        }
        .mod-item button {
            margin-left: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            max-width: 200px;
            min-width: 150px;
        }
        .start-btn {
            background-color: #28a745;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        .save-btn {
            background-color: #007bff;
            color: white;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .status.running {
            background-color: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        .error-info {
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .character-warning {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .character-warning.error {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        }
        .message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        .message.chat { color: #28a745; }
        .message.error { color: #dc3545; background-color: #f8d7da; }
        .message.system { color: #007bff; background-color: #e7f3ff; }
        .message.server { color: #6f42c1; background-color: #f3e8ff; border-left: 3px solid #6f42c1; }
        .message.game { color: #fd7e14; background-color: #fff3e0; }
        .message.unknown { color: #6c757d; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aterbot æ§åˆ¶é¢æ¿</h1>

        <div class="config-section">
            <h3>åŸºç¡€é…ç½®</h3>
            <div class="form-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="server-address" placeholder="æœåŠ¡å™¨åœ°å€:ç«¯å£ (å¦‚: gm.rainplay.cn:25384)" oninput="parseServerAddress(this)">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    è¾“å…¥æ ¼å¼: æœåŠ¡å™¨åœ°å€:ç«¯å£ï¼Œå¦‚æœä¸å¡«ç«¯å£é»˜è®¤ä½¿ç”¨25565
                </div>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="username" placeholder="æœºå™¨äººç”¨æˆ·å" oninput="validateUsername(this)">
                <div style="margin-top: 5px;">
                    <button type="button" onclick="suggestUsername()" style="background-color: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px;">ğŸ² éšæœºæ¨èç”¨æˆ·å</button>
                    <small style="margin-left: 10px; color: #666;">å¦‚æœå½“å‰ç”¨æˆ·åè¢«è¸¢å‡ºï¼Œå¯ä»¥å°è¯•å…¶ä»–åå­—å–µ</small>
                </div>
                <div id="username-warning" class="character-warning" style="display: none; margin-top: 5px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;">
                    <strong>âš ï¸ ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦ï¼</strong><br>
                    MinecraftæœåŠ¡å™¨é€šå¸¸åªå…è®¸å­—æ¯(a-z, A-Z)å’Œæ•°å­—(0-9)ï¼Œä¸æ”¯æŒä¸‹åˆ’çº¿(_)ã€ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦å·ã€‚<br>
                    å»ºè®®ä½¿ç”¨çº¯å­—æ¯æ•°å­—ç»„åˆï¼Œå¦‚: BotSkon, AterBot123
                </div>
            </div>
            <div class="form-group">
                <label>æ¸¸æˆç‰ˆæœ¬:</label>
                <select id="java-version">
                    <option value="1.21.1">1.21.1</option>
                    <option value="1.21">1.21</option>
                    <option value="1.20.6">1.20.6</option>
                    <option value="1.20.4">1.20.4</option>
                    <option value="1.20.1">1.20.1</option>
                    <option value="1.19.4">1.19.4</option>
                    <option value="1.18.2">1.18.2</option>
                </select>
            </div>
            <div class="form-group">
                <label>è®¤è¯æ–¹å¼:</label>
                <select id="auth" disabled>
                    <option value="offline">ç¦»çº¿æ¨¡å¼ (æœºå™¨äººä»…æ”¯æŒæ­¤æ¨¡å¼)</option>
                </select>
                <div style="margin-top: 5px; padding: 6px; background-color: #e7f3ff; border: 1px solid #b8daff; border-radius: 4px; font-size: 12px; color: #004085;">
                    <strong>ğŸ’¡ æç¤º:</strong> æœºå™¨äººåªèƒ½ä½¿ç”¨ç¦»çº¿æ¨¡å¼è¿æ¥æœåŠ¡å™¨ï¼Œä¸æ”¯æŒæ­£ç‰ˆéªŒè¯ã€‚
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ¨ çš®è‚¤é…ç½®</h3>
            <div class="form-group">
                <label>çš®è‚¤æ¨¡å¼:</label>
                <select id="skinMode" onchange="updateSkinMode()">
                    <option value="default">é»˜è®¤çš®è‚¤ (Steve)</option>
                    <option value="url">è‡ªå®šä¹‰çš®è‚¤URL</option>
                    <option value="yggdrasil">ç¬¬ä¸‰æ–¹çš®è‚¤ç«™ (Yggdrasil)</option>
                    <option value="littleskin">LittleSkinçš®è‚¤ç«™</option>
                </select>
            </div>

            <div id="skin-url-section" class="form-group" style="display: none;">
                <label>çš®è‚¤URL:</label>
                <input type="url" id="skinUrl" placeholder="https://example.com/skin.png">
            </div>

            <div id="yggdrasil-section" style="display: none;">
                <div class="form-group">
                    <label>YggdrasilæœåŠ¡å™¨:</label>
                    <select id="skinServer" onchange="updateYggdrasilUrl()">
                        <option value="https://littleskin.cn/api/yggdrasil">LittleSkin</option>
                        <option value="https://auth.mc-user.com:233">ç»Ÿä¸€é€šè¡Œè¯</option>
                        <option value="custom">è‡ªå®šä¹‰æœåŠ¡å™¨</option>
                    </select>
                </div>
                <div id="custom-yggdrasil" class="form-group" style="display: none;">
                    <label>è‡ªå®šä¹‰Yggdrasil URL:</label>
                    <input type="url" id="customYggdrasilUrl" placeholder="https://your-server.com/api/yggdrasil">
                </div>
                <div class="form-group">
                    <label>çš®è‚¤ç«™ç”¨æˆ·å:</label>
                    <input type="text" id="yggdrasilUsername" placeholder="åœ¨çš®è‚¤ç«™çš„ç”¨æˆ·å">
                </div>
            </div>

            <div id="littleskin-section" style="display: none;">
                <div class="form-group">
                    <label>LittleSkinç”¨æˆ·å:</label>
                    <input type="text" id="littleskinUsername" placeholder="LittleSkinç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enableLittleskinAuth" onchange="updateLittleskinAuth()" style="margin-right: 8px;"> 
                        å¯ç”¨LittleSkinè®¤è¯
                    </label>
                </div>
                <div id="littleskin-auth-section" class="form-group" style="display: none;">
                    <label>LittleSkinå¯†ç :</label>
                    <input type="password" id="littleskinPassword" placeholder="LittleSkinè´¦æˆ·å¯†ç ">
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>æ¨¡ç»„é…ç½®</h3>
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="adaptive-mods" onchange="updateAdaptiveMode()" style="margin-right: 8px;"> 
                    å¯ç”¨è‡ªé€‚åº”modæ¨¡å¼
                </label>
                <div style="margin: 8px 0; padding: 8px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px;">
                    <strong>ğŸ”¥ è‡ªé€‚åº”æ¨¡å¼:</strong> æœºå™¨äººä¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨è¦æ±‚çš„modåˆ—è¡¨ï¼Œç„¶åä¼ªè£…æˆæ‹¥æœ‰è¿™äº›modï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å–µï¼
                </div>
            </div>
            <div id="manual-mods-section">
                <div id="mod-list" class="mod-list"></div>
                <button type="button" onclick="addMod()">æ·»åŠ å‡mod</button>
                <button type="button" onclick="addCommonMods()" style="margin-left: 10px; background-color: #17a2b8; color: white;">æ·»åŠ å¸¸ç”¨mod</button>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ® æœºå™¨äººæ§åˆ¶é¢æ¿</h3>
            <div class="control-buttons">
                <button class="save-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button id="toggle-btn" class="start-btn" onclick="toggleBot()">â–¶ï¸ å¯åŠ¨æœºå™¨äºº</button>
            </div>
            <div id="status" class="status stopped">æœºå™¨äººçŠ¶æ€: å·²åœæ­¢</div>
        </div>

        <div id="error-info" class="error-info hidden"></div>

        <div class="config-section" id="command-section" style="display: none;">
            <h3>ğŸ® æœºå™¨äººå‘½ä»¤æ§åˆ¶</h3>
            <div class="form-group">
                <label>æ‰§è¡ŒMinecraftå‘½ä»¤:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="minecraft-command" placeholder="è¾“å…¥å‘½ä»¤ (å¦‚: /time set day)" style="flex: 1;">
                    <button onclick="executeMinecraftCommand()" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px;">æ‰§è¡Œ</button>
                </div>
            </div>

            <div class="form-group">
                <label>å‘é€èŠå¤©æ¶ˆæ¯:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯" style="flex: 1;">
                    <button onclick="sendChatMessage()" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px;">å‘é€</button>
                </div>
            </div>

            <div class="form-group">
                <label>æœåŠ¡å™¨æ¶ˆæ¯ç›‘æ§:</label>
                <div id="server-messages" style="height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f0f8ff; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 10px;">
                    <!-- æœåŠ¡å™¨æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <button onclick="clearServerMessages()" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 10px;">æ¸…é™¤æ¶ˆæ¯</button>
                <button onclick="toggleAutoScroll()" id="auto-scroll-btn" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px;">è‡ªåŠ¨æ»šåŠ¨: å¼€</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'java';
        let config = {};
        let mods = [];
        let eventSource = null;
        let autoScroll = true;

        // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰é…ç½®
        window.onload = function() {
            loadConfig();
            updateStatus();
            setInterval(updateStatus, 2000);
        };

        // è§£ææœåŠ¡å™¨åœ°å€å‡½æ•°
        function parseServerAddress(input) {
            const value = input.value.trim();
            if (!value) return;

            if (value.includes(':')) {
                const parts = value.split(':');
                if (parts.length === 2) {
                    const host = parts[0].trim();
                    const port = parts[1].trim();

                    if (port && !/^\d+$/.test(port)) {
                        input.style.borderColor = '#dc3545';
                        input.title = 'ç«¯å£å¿…é¡»æ˜¯æ•°å­—å–µï¼';
                    } else if (port && (parseInt(port) < 1 || parseInt(port) > 65535)) {
                        input.style.borderColor = '#dc3545';
                        input.title = 'ç«¯å£èŒƒå›´å¿…é¡»åœ¨1-65535ä¹‹é—´å–µï¼';
                    } else {
                        input.style.borderColor = '#28a745';
                        input.title = `æœåŠ¡å™¨: ${host}ï¼Œç«¯å£: ${port || '25565'}`;
                    }
                }
            } else {
                input.style.borderColor = '#17a2b8';
                input.title = `æœåŠ¡å™¨: ${value}ï¼Œç«¯å£: 25565 (é»˜è®¤)`;
            }
        }

        // ç”¨æˆ·åéªŒè¯å‡½æ•°
        function validateUsername(input) {
            const username = input.value;
            const warningEl = document.getElementById('username-warning');

            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (illegalChars && illegalChars.length > 0) {
                const uniqueChars = [...new Set(illegalChars)];
                const suggestionName = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                warningEl.innerHTML = `
                    <strong>ğŸš« ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦: ${uniqueChars.join(', ')}</strong><br>
                    <strong>ğŸ’¡ å»ºè®®ä¿®æ”¹ä¸º:</strong> <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">${suggestionName}</code><br>
                    <small>åªå…è®¸ä½¿ç”¨å­—æ¯(a-z, A-Z)å’Œæ•°å­—(0-9)ï¼Œä¸æ”¯æŒä¸‹åˆ’çº¿ã€ç©ºæ ¼ã€ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦å–µ~</small>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length > 16) {
                warningEl.innerHTML = `
                    <strong>ğŸ“ ç”¨æˆ·åè¿‡é•¿ï¼</strong><br>
                    Minecraftç”¨æˆ·åé™åˆ¶ä¸ºæœ€å¤š16ä¸ªå­—ç¬¦ï¼Œå½“å‰é•¿åº¦: ${username.length} ä¸ªå­—ç¬¦<br>
                    <strong>å»ºè®®ç¼©çŸ­ä¸º:</strong> <code>${username.substring(0, 16)}</code>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length >= 3) {
                warningEl.innerHTML = `
                    <strong>âœ… ç”¨æˆ·åæ ¼å¼å®Œå…¨æ­£ç¡®å–µï¼</strong><br>
                    æœºå™¨äººå¯ä»¥æ­£å¸¸ä½¿ç”¨æ­¤ç”¨æˆ·åè¿›å…¥æœåŠ¡å™¨å–µ~
                `;
                warningEl.className = 'character-warning';
                warningEl.style.display = 'block';
                warningEl.style.backgroundColor = '#d1ecf1';
                warningEl.style.borderColor = '#bee5eb';
                warningEl.style.color = '#0c5460';
            } else {
                warningEl.style.display = 'none';
            }
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    config = data;
                    updateUI();
                })
                .catch(error => console.error('åŠ è½½é…ç½®å¤±è´¥:', error));
        }

        function updateUI() {
            const host = config.client?.host || '';
            const port = config.client?.port || '';
            const serverAddress = host && port ? `${host}:${port}` : (host || '');

            document.getElementById('server-address').value = serverAddress;
            document.getElementById('username').value = config.client?.username || '';
            document.getElementById('java-version').value = config.client?.version || '1.21.1';
            document.getElementById('auth').value = config.client?.auth || 'offline';

            mods = config.client?.mods || [];
            updateModList();

            document.getElementById('adaptive-mods').checked = config.client?.adaptiveMods || false;
            updateAdaptiveMode();

            if (config.client?.skinMode) {
                document.getElementById('skinMode').value = config.client.skinMode;
                updateSkinMode();
            }
            if (config.client?.skinUrl) {
                document.getElementById('skinUrl').value = config.client.skinUrl;
            }
            if (config.client?.yggdrasilServer) {
                const serverSelect = document.getElementById('skinServer');
                if ([...serverSelect.options].some(option => option.value === config.client.yggdrasilServer)) {
                    serverSelect.value = config.client.yggdrasilServer;
                } else {
                    serverSelect.value = 'custom';
                    document.getElementById('customYggdrasilUrl').value = config.client.yggdrasilServer;
                }
                updateYggdrasilUrl();
            }
            if (config.client?.yggdrasilUsername) {
                document.getElementById('yggdrasilUsername').value = config.client.yggdrasilUsername;
            }
            if (config.client?.littleskinUsername) {
                document.getElementById('littleskinUsername').value = config.client.littleskinUsername;
            }
            if (config.client?.littleskinPassword) {
                document.getElementById('littleskinPassword').value = config.client.littleskinPassword;
            }
            if (config.client?.enableLittleskinAuth !== undefined) {
                document.getElementById('enableLittleskinAuth').checked = config.client.enableLittleskinAuth;
                updateLittleskinAuth();
            }
        }

        function updateSkinMode() {
            const skinMode = document.getElementById('skinMode').value;
            const skinUrlSection = document.getElementById('skin-url-section');
            const yggdrasilSection = document.getElementById('yggdrasil-section');
            const littleskinSection = document.getElementById('littleskin-section');

            skinUrlSection.style.display = 'none';
            yggdrasilSection.style.display = 'none';
            littleskinSection.style.display = 'none';

            if (skinMode === 'url') {
                skinUrlSection.style.display = 'block';
            } else if (skinMode === 'yggdrasil') {
                yggdrasilSection.style.display = 'block';
            } else if (skinMode === 'littleskin') {
                littleskinSection.style.display = 'block';
            }
        }

        function updateYggdrasilUrl() {
            const serverSelect = document.getElementById('skinServer');
            const customSection = document.getElementById('custom-yggdrasil');

            if (serverSelect.value === 'custom') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
            }
        }

        function updateLittleskinAuth() {
            const enableAuth = document.getElementById('enableLittleskinAuth').checked;
            const authSection = document.getElementById('littleskin-auth-section');

            if (enableAuth) {
                authSection.style.display = 'block';
            } else {
                authSection.style.display = 'none';
            }
        }

        function updateAdaptiveMode() {
            const isAdaptive = document.getElementById('adaptive-mods').checked;
            const manualSection = document.getElementById('manual-mods-section');

            if (isAdaptive) {
                manualSection.style.opacity = '0.5';
                manualSection.style.pointerEvents = 'none';
            } else {
                manualSection.style.opacity = '1';
                manualSection.style.pointerEvents = 'auto';
            }
        }

        function addMod() {
            mods.push('');
            updateModList();
        }

        function removeMod(index) {
            mods.splice(index, 1);
            updateModList();
        }

        function updateModList() {
            const modListEl = document.getElementById('mod-list');
            modListEl.innerHTML = '';

            mods.forEach((mod, index) => {
                const modItem = document.createElement('div');
                modItem.className = 'mod-item';
                modItem.innerHTML = `
                    <input type="text" value="${mod}" placeholder="modåç§° (å¦‚: forge, optifine, jei)" 
                           onchange="mods[${index}] = this.value">
                    <button onclick="removeMod(${index})">åˆ é™¤</button>
                `;
                modListEl.appendChild(modItem);
            });
        }

        function addCommonMods() {
            const commonMods = ['forge', 'optifine', 'jei', 'journeymap', 'waila'];
            const selectedMods = prompt('é€‰æ‹©è¦æ·»åŠ çš„å¸¸ç”¨mod (ç”¨é€—å·åˆ†éš”):\n' + commonMods.join(', '));

            if (selectedMods) {
                const modsToAdd = selectedMods.split(',').map(m => m.trim()).filter(m => m);
                modsToAdd.forEach(mod => {
                    if (!mods.includes(mod)) {
                        mods.push(mod);
                    }
                });
                updateModList();
            }
        }

        function saveConfig() {
            const username = document.getElementById('username').value;
            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (!username.trim()) {
                alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºå–µï¼');
                return;
            }

            if (illegalChars && illegalChars.length > 0) {
                const suggestion = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                alert(`ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦: ${[...new Set(illegalChars)].join(', ')}\nå»ºè®®ä¿®æ”¹ä¸º: ${suggestion}`);
                return;
            }

            const serverAddress = document.getElementById('server-address').value.trim();
            let host = '';
            let port = '';

            if (serverAddress.includes(':')) {
                const parts = serverAddress.split(':');
                host = parts[0].trim();
                port = parts[1].trim();
            } else {
                host = serverAddress;
                port = '25565';
            }

            const newConfig = {
                ...config,
                client: {
                    ...config.client,
                    host: host,
                    port: port,
                    username: username,
                    version: document.getElementById('java-version').value,
                    auth: 'offline',
                    adaptiveMods: document.getElementById('adaptive-mods').checked,
                    mods: mods.filter(mod => mod.trim() !== ''),
                    skinMode: document.getElementById('skinMode').value,
                    skinUrl: document.getElementById('skinUrl').value || null
                }
            };

            const skinMode = document.getElementById('skinMode').value;

            if (skinMode === 'yggdrasil') {
                const skinServer = document.getElementById('skinServer').value;
                const customUrl = document.getElementById('customYggdrasilUrl').value;
                const yggdrasilUsername = document.getElementById('yggdrasilUsername').value;

                newConfig.client.yggdrasilServer = skinServer === 'custom' ? customUrl : skinServer;
                newConfig.client.yggdrasilUsername = yggdrasilUsername;
            }

            if (skinMode === 'littleskin') {
                const littleskinUsername = document.getElementById('littleskinUsername').value;
                const enableLittleskinAuth = document.getElementById('enableLittleskinAuth').checked;
                const littleskinPassword = document.getElementById('littleskinPassword').value;

                newConfig.client.littleskinUsername = littleskinUsername;
                newConfig.client.enableLittleskinAuth = enableLittleskinAuth;
                if (enableLittleskinAuth && littleskinPassword) {
                    newConfig.client.littleskinPassword = littleskinPassword;
                }
            }

            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
                    config = newConfig;
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜é…ç½®å¤±è´¥');
            });
        }

        function toggleBot() {
            const statusEl = document.getElementById('status');
            if (statusEl.className === 'status running') {
                stopBot();
            } else {
                startBot();
            }
        }

        function startBot() {
            document.getElementById('error-info').className = 'error-info hidden';

            fetch('/api/bot/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æœºå™¨äººå¯åŠ¨æˆåŠŸï¼');
                        setTimeout(updateStatus, 1000);
                    } else {
                        alert('å¯åŠ¨å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('å¯åŠ¨æœºå™¨äººå¤±è´¥:', error);
                    alert('å¯åŠ¨æœºå™¨äººå¤±è´¥');
                });
        }

        function stopBot() {
            fetch('/api/bot/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æœºå™¨äººå·²åœæ­¢ï¼');
                        setTimeout(() => {
                            updateStatus();
                        }, 500);
                    } else {
                        alert('åœæ­¢å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åœæ­¢æœºå™¨äººå¤±è´¥:', error);
                    alert('åœæ­¢æœºå™¨äººå¤±è´¥');
                });
        }

        function updateToggleButton(isRunning) {
            const toggleBtn = document.getElementById('toggle-btn');
            if (isRunning) {
                toggleBtn.textContent = 'â¹ï¸ åœæ­¢æœºå™¨äºº';
                toggleBtn.className = 'stop-btn';
            } else {
                toggleBtn.textContent = 'â–¶ï¸ å¯åŠ¨æœºå™¨äºº';
                toggleBtn.className = 'start-btn';
            }
        }

        function updateStatus() {
            fetch('/api/bot/status')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status');
                    const errorEl = document.getElementById('error-info');
                    const commandSection = document.getElementById('command-section');

                    if (data.running) {
                        statusEl.textContent = 'æœºå™¨äººçŠ¶æ€: è¿è¡Œä¸­';
                        statusEl.className = 'status running';
                        errorEl.className = 'error-info hidden';
                        commandSection.style.display = 'block';
                        updateToggleButton(true);

                        if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                            connectToMessageStream();
                        }
                    } else {
                        statusEl.textContent = 'æœºå™¨äººçŠ¶æ€: å·²åœæ­¢';
                        statusEl.className = 'status stopped';
                        commandSection.style.display = 'none';
                        updateToggleButton(false);

                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }

                        if (data.error) {
                            errorEl.innerHTML = '<h4>ğŸš¨ å¯åŠ¨å¤±è´¥åŸå› :</h4>' + data.error;
                            errorEl.className = 'error-info';
                        } else {
                            errorEl.className = 'error-info hidden';
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                });
        }

        function executeMinecraftCommand() {
            const command = document.getElementById('minecraft-command').value.trim();
            if (!command) {
                alert('è¯·è¾“å…¥å‘½ä»¤å–µï¼');
                return;
            }

            const fullCommand = command.startsWith('/') ? command : '/' + command;

            fetch('/api/bot/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: fullCommand })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`âœ… å‘½ä»¤æ‰§è¡Œ: ${fullCommand}`);
                    document.getElementById('minecraft-command').value = '';
                } else {
                    console.log(`âŒ å‘½ä»¤å¤±è´¥: ${fullCommand} - ${data.message}`);
                }
            })
            .catch(error => {
                console.log(`âŒ ç½‘ç»œé”™è¯¯: ${fullCommand} - ${error.message}`);
            });
        }

        function sendChatMessage() {
            const message = document.getElementById('chat-message').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å–µï¼');
                return;
            }

            fetch('/api/bot/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`ğŸ’¬ èŠå¤©å‘é€: ${message}`);
                    document.getElementById('chat-message').value = '';
                } else {
                    console.log(`âŒ èŠå¤©å¤±è´¥: ${message} - ${data.message}`);
                }
            })
            .catch(error => {
                console.log(`âŒ ç½‘ç»œé”™è¯¯: ${message} - ${error.message}`);
            });
        }

        function connectToMessageStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            console.log('ğŸ”— æ­£åœ¨è¿æ¥åˆ°æ¶ˆæ¯æµ...');

            try {
                eventSource = new EventSource('/api/events');

                eventSource.onopen = function(event) {
                    console.log('âœ… æ¶ˆæ¯æµè¿æ¥æˆåŠŸ');
                };

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addServerMessage(data.message, data.timestamp, data.type);
                    } catch (error) {
                        console.error('âŒ è§£ææ¶ˆæ¯å¤±è´¥:', error);
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('ğŸ’¥ æ¶ˆæ¯æµè¿æ¥é”™è¯¯:', error);
                    setTimeout(() => {
                        if (document.getElementById('status').className === 'status running') {
                            connectToMessageStream();
                        }
                    }, 3000);
                };

            } catch (error) {
                console.error('ğŸ’¥ åˆ›å»ºæ¶ˆæ¯æµè¿æ¥å¤±è´¥:', error);
            }
        }

        function addServerMessage(message, timestamp, type = 'chat') {
            const messagesEl = document.getElementById('server-messages');
            if (!messagesEl) return;

            const time = new Date(timestamp).toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 3px; padding: 8px; border-radius: 4px; border-left: 3px solid #ddd; background-color: #f8f9fa;';
            messageDiv.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">[${time}]</div>
                <div style="font-family: 'Courier New', monospace; font-size: 13px;">ğŸ’¬ ${message}</div>
            `;

            messagesEl.appendChild(messageDiv);

            if (autoScroll) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            while (messagesEl.children.length > 200) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        function clearServerMessages() {
            document.getElementById('server-messages').innerHTML = '';
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('auto-scroll-btn');
            btn.textContent = `è‡ªåŠ¨æ»šåŠ¨: ${autoScroll ? 'å¼€' : 'å…³'}`;
            btn.style.backgroundColor = autoScroll ? '#28a745' : '#6c757d';
        }

        function suggestUsername() {
            const simpleNames = ['BotSkon', 'AterBot', 'AutoBot', 'HelperBot', 'TestBot', 'PlayerBot', 'GameBot', 'MCBot'];
            const suggestedName = simpleNames[Math.floor(Math.random() * simpleNames.length)];

            document.getElementById('username').value = suggestedName;
            validateUsername(document.getElementById('username'));

            alert(`ğŸ’¡ æ¨èç”¨æˆ·å: ${suggestedName}\n\nè¿™ä¸ªåå­—å®Œå…¨ç¬¦åˆMinecraftæœåŠ¡å™¨è¦æ±‚ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å–µï¼`);
        }

        // å›è½¦é”®å¿«æ·æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('minecraft-command').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeMinecraftCommand();
                }
            });

            document.getElementById('chat-message').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
    </script>
</body>
</html>