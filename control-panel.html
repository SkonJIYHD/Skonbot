<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aterbot 控制面板</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .config-section h3 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .mod-list {
            margin-top: 10px;
        }
        .mod-item {
            display: flex;
            margin-bottom: 10px;
        }
        .mod-item input {
            flex: 1;
            margin-right: 10px;
        }
        .mod-item button {
            margin-left: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            max-width: 200px;
            min-width: 150px;
        }
        .start-btn {
            background-color: #28a745;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        .save-btn {
            background-color: #007bff;
            color: white;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .status.running {
            background-color: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background-color: #f8d7da;
            color: #721c24;
        }
        .error-info {
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .character-warning {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .character-warning.error {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
        }
        .message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        .message.chat { color: #28a745; }
        .message.error { color: #dc3545; background-color: #f8d7da; }
        .message.system { color: #007bff; background-color: #e7f3ff; }
        .message.server { color: #6f42c1; background-color: #f3e8ff; border-left: 3px solid #6f42c1; }
        .message.game { color: #fd7e14; background-color: #fff3e0; }
        .message.unknown { color: #6c757d; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aterbot 控制面板</h1>

        <div class="config-section">
            <h3>基础配置</h3>
            <div class="form-group">
                <label>服务器地址:</label>
                <input type="text" id="server-address" placeholder="服务器地址:端口 (如: gm.rainplay.cn:25384)" oninput="parseServerAddress(this)">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    输入格式: 服务器地址:端口，如果不填端口默认使用25565
                </div>
            </div>
            <div class="form-group">
                <label>用户名:</label>
                <input type="text" id="username" placeholder="机器人用户名" oninput="validateUsername(this)">
                <div style="margin-top: 5px;">
                    <button type="button" onclick="suggestUsername()" style="background-color: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px;">🎲 随机推荐用户名</button>
                    <small style="margin-left: 10px; color: #666;">如果当前用户名被踢出，可以尝试其他名字喵</small>
                </div>
                <div id="username-warning" class="character-warning" style="display: none; margin-top: 5px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;">
                    <strong>⚠️ 用户名包含非法字符！</strong><br>
                    Minecraft服务器通常只允许字母(a-z, A-Z)和数字(0-9)，不支持下划线(_)、空格或特殊符号。<br>
                    建议使用纯字母数字组合，如: BotSkon, AterBot123
                </div>
            </div>
            <div class="form-group">
                <label>游戏版本:</label>
                <select id="java-version">
                    <option value="1.21.1">1.21.1</option>
                    <option value="1.21">1.21</option>
                    <option value="1.20.6">1.20.6</option>
                    <option value="1.20.4">1.20.4</option>
                    <option value="1.20.1">1.20.1</option>
                    <option value="1.19.4">1.19.4</option>
                    <option value="1.18.2">1.18.2</option>
                </select>
            </div>
            <div class="form-group">
                <label>认证方式:</label>
                <select id="auth" disabled>
                    <option value="offline">离线模式 (机器人仅支持此模式)</option>
                </select>
                <div style="margin-top: 5px; padding: 6px; background-color: #e7f3ff; border: 1px solid #b8daff; border-radius: 4px; font-size: 12px; color: #004085;">
                    <strong>💡 提示:</strong> 机器人只能使用离线模式连接服务器，不支持正版验证。
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>🎨 皮肤配置</h3>
            <div class="form-group">
                <label>皮肤模式:</label>
                <select id="skinMode" onchange="updateSkinMode()">
                    <option value="default">默认皮肤 (Steve)</option>
                    <option value="url">自定义皮肤URL</option>
                    <option value="yggdrasil">第三方皮肤站 (Yggdrasil)</option>
                    <option value="littleskin">LittleSkin皮肤站</option>
                </select>
            </div>

            <div id="skin-url-section" class="form-group" style="display: none;">
                <label>皮肤URL:</label>
                <input type="url" id="skinUrl" placeholder="https://example.com/skin.png">
            </div>

            <div id="yggdrasil-section" style="display: none;">
                <div class="form-group">
                    <label>Yggdrasil服务器:</label>
                    <select id="skinServer" onchange="updateYggdrasilUrl()">
                        <option value="https://littleskin.cn/api/yggdrasil">LittleSkin</option>
                        <option value="https://auth.mc-user.com:233">统一通行证</option>
                        <option value="custom">自定义服务器</option>
                    </select>
                </div>
                <div id="custom-yggdrasil" class="form-group" style="display: none;">
                    <label>自定义Yggdrasil URL:</label>
                    <input type="url" id="customYggdrasilUrl" placeholder="https://your-server.com/api/yggdrasil">
                </div>
                <div class="form-group">
                    <label>皮肤站用户名:</label>
                    <input type="text" id="yggdrasilUsername" placeholder="在皮肤站的用户名">
                </div>
            </div>

            <div id="littleskin-section" style="display: none;">
                <div class="form-group">
                    <label>LittleSkin用户名:</label>
                    <input type="text" id="littleskinUsername" placeholder="LittleSkin用户名">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enableLittleskinAuth" onchange="updateLittleskinAuth()" style="margin-right: 8px;"> 
                        启用LittleSkin认证
                    </label>
                </div>
                <div id="littleskin-auth-section" class="form-group" style="display: none;">
                    <label>LittleSkin密码:</label>
                    <input type="password" id="littleskinPassword" placeholder="LittleSkin账户密码">
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>模组配置</h3>
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="adaptive-mods" onchange="updateAdaptiveMode()" style="margin-right: 8px;"> 
                    启用自适应mod模式
                </label>
                <div style="margin: 8px 0; padding: 8px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px;">
                    <strong>🔥 自适应模式:</strong> 机器人会自动检测服务器要求的mod列表，然后伪装成拥有这些mod，无需手动配置喵！
                </div>
            </div>
            <div id="manual-mods-section">
                <div id="mod-list" class="mod-list"></div>
                <button type="button" onclick="addMod()">添加假mod</button>
                <button type="button" onclick="addCommonMods()" style="margin-left: 10px; background-color: #17a2b8; color: white;">添加常用mod</button>
            </div>
        </div>

        <div class="config-section">
            <h3>🎮 机器人控制面板</h3>
            <div class="control-buttons">
                <button class="save-btn" onclick="saveConfig()">💾 保存配置</button>
                <button id="toggle-btn" class="start-btn" onclick="toggleBot()">▶️ 启动机器人</button>
            </div>
            <div id="status" class="status stopped">机器人状态: 已停止</div>
        </div>

        <div id="error-info" class="error-info hidden"></div>

        <div class="config-section" id="command-section" style="display: none;">
            <h3>🎮 机器人命令控制</h3>
            <div class="form-group">
                <label>执行Minecraft命令:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="minecraft-command" placeholder="输入命令 (如: /time set day)" style="flex: 1;">
                    <button onclick="executeMinecraftCommand()" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px;">执行</button>
                </div>
            </div>

            <div class="form-group">
                <label>发送聊天消息:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message" placeholder="输入要发送的消息" style="flex: 1;">
                    <button onclick="sendChatMessage()" style="background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px;">发送</button>
                </div>
            </div>

            <div class="form-group">
                <label>服务器消息监控:</label>
                <div id="server-messages" style="height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f0f8ff; font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 10px;">
                    <!-- 服务器消息将在这里显示 -->
                </div>
                <button onclick="clearServerMessages()" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 10px;">清除消息</button>
                <button onclick="toggleAutoScroll()" id="auto-scroll-btn" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px;">自动滚动: 开</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'java';
        let config = {};
        let mods = [];
        let eventSource = null;
        let autoScroll = true;

        // 页面加载时获取当前配置
        window.onload = function() {
            loadConfig();
            updateStatus();
            setInterval(updateStatus, 2000);
        };

        // 解析服务器地址函数
        function parseServerAddress(input) {
            const value = input.value.trim();
            if (!value) return;

            if (value.includes(':')) {
                const parts = value.split(':');
                if (parts.length === 2) {
                    const host = parts[0].trim();
                    const port = parts[1].trim();

                    if (port && !/^\d+$/.test(port)) {
                        input.style.borderColor = '#dc3545';
                        input.title = '端口必须是数字喵！';
                    } else if (port && (parseInt(port) < 1 || parseInt(port) > 65535)) {
                        input.style.borderColor = '#dc3545';
                        input.title = '端口范围必须在1-65535之间喵！';
                    } else {
                        input.style.borderColor = '#28a745';
                        input.title = `服务器: ${host}，端口: ${port || '25565'}`;
                    }
                }
            } else {
                input.style.borderColor = '#17a2b8';
                input.title = `服务器: ${value}，端口: 25565 (默认)`;
            }
        }

        // 用户名验证函数
        function validateUsername(input) {
            const username = input.value;
            const warningEl = document.getElementById('username-warning');

            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (illegalChars && illegalChars.length > 0) {
                const uniqueChars = [...new Set(illegalChars)];
                const suggestionName = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                warningEl.innerHTML = `
                    <strong>🚫 用户名包含非法字符: ${uniqueChars.join(', ')}</strong><br>
                    <strong>💡 建议修改为:</strong> <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">${suggestionName}</code><br>
                    <small>只允许使用字母(a-z, A-Z)和数字(0-9)，不支持下划线、空格、中文等特殊字符喵~</small>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length > 16) {
                warningEl.innerHTML = `
                    <strong>📏 用户名过长！</strong><br>
                    Minecraft用户名限制为最多16个字符，当前长度: ${username.length} 个字符<br>
                    <strong>建议缩短为:</strong> <code>${username.substring(0, 16)}</code>
                `;
                warningEl.className = 'character-warning error';
                warningEl.style.display = 'block';
            } else if (username.length >= 3) {
                warningEl.innerHTML = `
                    <strong>✅ 用户名格式完全正确喵！</strong><br>
                    机器人可以正常使用此用户名进入服务器喵~
                `;
                warningEl.className = 'character-warning';
                warningEl.style.display = 'block';
                warningEl.style.backgroundColor = '#d1ecf1';
                warningEl.style.borderColor = '#bee5eb';
                warningEl.style.color = '#0c5460';
            } else {
                warningEl.style.display = 'none';
            }
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    config = data;
                    updateUI();
                })
                .catch(error => console.error('加载配置失败:', error));
        }

        function updateUI() {
            const host = config.client?.host || '';
            const port = config.client?.port || '';
            const serverAddress = host && port ? `${host}:${port}` : (host || '');

            document.getElementById('server-address').value = serverAddress;
            document.getElementById('username').value = config.client?.username || '';
            document.getElementById('java-version').value = config.client?.version || '1.21.1';
            document.getElementById('auth').value = config.client?.auth || 'offline';

            mods = config.client?.mods || [];
            updateModList();

            document.getElementById('adaptive-mods').checked = config.client?.adaptiveMods || false;
            updateAdaptiveMode();

            if (config.client?.skinMode) {
                document.getElementById('skinMode').value = config.client.skinMode;
                updateSkinMode();
            }
            if (config.client?.skinUrl) {
                document.getElementById('skinUrl').value = config.client.skinUrl;
            }
            if (config.client?.yggdrasilServer) {
                const serverSelect = document.getElementById('skinServer');
                if ([...serverSelect.options].some(option => option.value === config.client.yggdrasilServer)) {
                    serverSelect.value = config.client.yggdrasilServer;
                } else {
                    serverSelect.value = 'custom';
                    document.getElementById('customYggdrasilUrl').value = config.client.yggdrasilServer;
                }
                updateYggdrasilUrl();
            }
            if (config.client?.yggdrasilUsername) {
                document.getElementById('yggdrasilUsername').value = config.client.yggdrasilUsername;
            }
            if (config.client?.littleskinUsername) {
                document.getElementById('littleskinUsername').value = config.client.littleskinUsername;
            }
            if (config.client?.littleskinPassword) {
                document.getElementById('littleskinPassword').value = config.client.littleskinPassword;
            }
            if (config.client?.enableLittleskinAuth !== undefined) {
                document.getElementById('enableLittleskinAuth').checked = config.client.enableLittleskinAuth;
                updateLittleskinAuth();
            }
        }

        function updateSkinMode() {
            const skinMode = document.getElementById('skinMode').value;
            const skinUrlSection = document.getElementById('skin-url-section');
            const yggdrasilSection = document.getElementById('yggdrasil-section');
            const littleskinSection = document.getElementById('littleskin-section');

            skinUrlSection.style.display = 'none';
            yggdrasilSection.style.display = 'none';
            littleskinSection.style.display = 'none';

            if (skinMode === 'url') {
                skinUrlSection.style.display = 'block';
            } else if (skinMode === 'yggdrasil') {
                yggdrasilSection.style.display = 'block';
            } else if (skinMode === 'littleskin') {
                littleskinSection.style.display = 'block';
            }
        }

        function updateYggdrasilUrl() {
            const serverSelect = document.getElementById('skinServer');
            const customSection = document.getElementById('custom-yggdrasil');

            if (serverSelect.value === 'custom') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
            }
        }

        function updateLittleskinAuth() {
            const enableAuth = document.getElementById('enableLittleskinAuth').checked;
            const authSection = document.getElementById('littleskin-auth-section');

            if (enableAuth) {
                authSection.style.display = 'block';
            } else {
                authSection.style.display = 'none';
            }
        }

        function updateAdaptiveMode() {
            const isAdaptive = document.getElementById('adaptive-mods').checked;
            const manualSection = document.getElementById('manual-mods-section');

            if (isAdaptive) {
                manualSection.style.opacity = '0.5';
                manualSection.style.pointerEvents = 'none';
            } else {
                manualSection.style.opacity = '1';
                manualSection.style.pointerEvents = 'auto';
            }
        }

        function addMod() {
            mods.push('');
            updateModList();
        }

        function removeMod(index) {
            mods.splice(index, 1);
            updateModList();
        }

        function updateModList() {
            const modListEl = document.getElementById('mod-list');
            modListEl.innerHTML = '';

            mods.forEach((mod, index) => {
                const modItem = document.createElement('div');
                modItem.className = 'mod-item';
                modItem.innerHTML = `
                    <input type="text" value="${mod}" placeholder="mod名称 (如: forge, optifine, jei)" 
                           onchange="mods[${index}] = this.value">
                    <button onclick="removeMod(${index})">删除</button>
                `;
                modListEl.appendChild(modItem);
            });
        }

        function addCommonMods() {
            const commonMods = ['forge', 'optifine', 'jei', 'journeymap', 'waila'];
            const selectedMods = prompt('选择要添加的常用mod (用逗号分隔):\n' + commonMods.join(', '));

            if (selectedMods) {
                const modsToAdd = selectedMods.split(',').map(m => m.trim()).filter(m => m);
                modsToAdd.forEach(mod => {
                    if (!mods.includes(mod)) {
                        mods.push(mod);
                    }
                });
                updateModList();
            }
        }

        function saveConfig() {
            const username = document.getElementById('username').value;
            const illegalChars = username.match(/[^a-zA-Z0-9]/g);

            if (!username.trim()) {
                alert('用户名不能为空喵！');
                return;
            }

            if (illegalChars && illegalChars.length > 0) {
                const suggestion = username.replace(/[^a-zA-Z0-9]/g, '') || 'BotSkon';
                alert(`用户名包含非法字符: ${[...new Set(illegalChars)].join(', ')}\n建议修改为: ${suggestion}`);
                return;
            }

            const serverAddress = document.getElementById('server-address').value.trim();
            let host = '';
            let port = '';

            if (serverAddress.includes(':')) {
                const parts = serverAddress.split(':');
                host = parts[0].trim();
                port = parts[1].trim();
            } else {
                host = serverAddress;
                port = '25565';
            }

            const newConfig = {
                ...config,
                client: {
                    ...config.client,
                    host: host,
                    port: port,
                    username: username,
                    version: document.getElementById('java-version').value,
                    auth: 'offline',
                    adaptiveMods: document.getElementById('adaptive-mods').checked,
                    mods: mods.filter(mod => mod.trim() !== ''),
                    skinMode: document.getElementById('skinMode').value,
                    skinUrl: document.getElementById('skinUrl').value || null
                }
            };

            const skinMode = document.getElementById('skinMode').value;

            if (skinMode === 'yggdrasil') {
                const skinServer = document.getElementById('skinServer').value;
                const customUrl = document.getElementById('customYggdrasilUrl').value;
                const yggdrasilUsername = document.getElementById('yggdrasilUsername').value;

                newConfig.client.yggdrasilServer = skinServer === 'custom' ? customUrl : skinServer;
                newConfig.client.yggdrasilUsername = yggdrasilUsername;
            }

            if (skinMode === 'littleskin') {
                const littleskinUsername = document.getElementById('littleskinUsername').value;
                const enableLittleskinAuth = document.getElementById('enableLittleskinAuth').checked;
                const littleskinPassword = document.getElementById('littleskinPassword').value;

                newConfig.client.littleskinUsername = littleskinUsername;
                newConfig.client.enableLittleskinAuth = enableLittleskinAuth;
                if (enableLittleskinAuth && littleskinPassword) {
                    newConfig.client.littleskinPassword = littleskinPassword;
                }
            }

            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('配置保存成功！');
                    config = newConfig;
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                alert('保存配置失败');
            });
        }

        function toggleBot() {
            const statusEl = document.getElementById('status');
            if (statusEl.className === 'status running') {
                stopBot();
            } else {
                startBot();
            }
        }

        function startBot() {
            document.getElementById('error-info').className = 'error-info hidden';

            fetch('/api/bot/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('机器人启动成功！');
                        setTimeout(updateStatus, 1000);
                    } else {
                        alert('启动失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('启动机器人失败:', error);
                    alert('启动机器人失败');
                });
        }

        function stopBot() {
            fetch('/api/bot/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('机器人已停止！');
                        setTimeout(() => {
                            updateStatus();
                        }, 500);
                    } else {
                        alert('停止失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('停止机器人失败:', error);
                    alert('停止机器人失败');
                });
        }

        function updateToggleButton(isRunning) {
            const toggleBtn = document.getElementById('toggle-btn');
            if (isRunning) {
                toggleBtn.textContent = '⏹️ 停止机器人';
                toggleBtn.className = 'stop-btn';
            } else {
                toggleBtn.textContent = '▶️ 启动机器人';
                toggleBtn.className = 'start-btn';
            }
        }

        function updateStatus() {
            fetch('/api/bot/status')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status');
                    const errorEl = document.getElementById('error-info');
                    const commandSection = document.getElementById('command-section');

                    if (data.running) {
                        statusEl.textContent = '机器人状态: 运行中';
                        statusEl.className = 'status running';
                        errorEl.className = 'error-info hidden';
                        commandSection.style.display = 'block';
                        updateToggleButton(true);

                        if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                            connectToMessageStream();
                        }
                    } else {
                        statusEl.textContent = '机器人状态: 已停止';
                        statusEl.className = 'status stopped';
                        commandSection.style.display = 'none';
                        updateToggleButton(false);

                        if (eventSource) {
                            eventSource.close();
                            eventSource = null;
                        }

                        if (data.error) {
                            errorEl.innerHTML = '<h4>🚨 启动失败原因:</h4>' + data.error;
                            errorEl.className = 'error-info';
                        } else {
                            errorEl.className = 'error-info hidden';
                        }
                    }
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                });
        }

        function executeMinecraftCommand() {
            const command = document.getElementById('minecraft-command').value.trim();
            if (!command) {
                alert('请输入命令喵！');
                return;
            }

            const fullCommand = command.startsWith('/') ? command : '/' + command;

            fetch('/api/bot/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: fullCommand })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`✅ 命令执行: ${fullCommand}`);
                    document.getElementById('minecraft-command').value = '';
                } else {
                    console.log(`❌ 命令失败: ${fullCommand} - ${data.message}`);
                }
            })
            .catch(error => {
                console.log(`❌ 网络错误: ${fullCommand} - ${error.message}`);
            });
        }

        function sendChatMessage() {
            const message = document.getElementById('chat-message').value.trim();
            if (!message) {
                alert('请输入消息喵！');
                return;
            }

            fetch('/api/bot/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`💬 聊天发送: ${message}`);
                    document.getElementById('chat-message').value = '';
                } else {
                    console.log(`❌ 聊天失败: ${message} - ${data.message}`);
                }
            })
            .catch(error => {
                console.log(`❌ 网络错误: ${message} - ${error.message}`);
            });
        }

        function connectToMessageStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            console.log('🔗 正在连接到消息流...');

            try {
                eventSource = new EventSource('/api/events');

                eventSource.onopen = function(event) {
                    console.log('✅ 消息流连接成功');
                };

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addServerMessage(data.message, data.timestamp, data.type);
                    } catch (error) {
                        console.error('❌ 解析消息失败:', error);
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('💥 消息流连接错误:', error);
                    setTimeout(() => {
                        if (document.getElementById('status').className === 'status running') {
                            connectToMessageStream();
                        }
                    }, 3000);
                };

            } catch (error) {
                console.error('💥 创建消息流连接失败:', error);
            }
        }

        function addServerMessage(message, timestamp, type = 'chat') {
            const messagesEl = document.getElementById('server-messages');
            if (!messagesEl) return;

            const time = new Date(timestamp).toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 3px; padding: 8px; border-radius: 4px; border-left: 3px solid #ddd; background-color: #f8f9fa;';
            messageDiv.innerHTML = `
                <div style="font-size: 11px; color: #666; margin-bottom: 2px;">[${time}]</div>
                <div style="font-family: 'Courier New', monospace; font-size: 13px;">💬 ${message}</div>
            `;

            messagesEl.appendChild(messageDiv);

            if (autoScroll) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            while (messagesEl.children.length > 200) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        function clearServerMessages() {
            document.getElementById('server-messages').innerHTML = '';
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('auto-scroll-btn');
            btn.textContent = `自动滚动: ${autoScroll ? '开' : '关'}`;
            btn.style.backgroundColor = autoScroll ? '#28a745' : '#6c757d';
        }

        function suggestUsername() {
            const simpleNames = ['BotSkon', 'AterBot', 'AutoBot', 'HelperBot', 'TestBot', 'PlayerBot', 'GameBot', 'MCBot'];
            const suggestedName = simpleNames[Math.floor(Math.random() * simpleNames.length)];

            document.getElementById('username').value = suggestedName;
            validateUsername(document.getElementById('username'));

            alert(`💡 推荐用户名: ${suggestedName}\n\n这个名字完全符合Minecraft服务器要求，可以尝试使用喵！`);
        }

        // 回车键快捷执行
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('minecraft-command').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeMinecraftCommand();
                }
            });

            document.getElementById('chat-message').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
    </script>
</body>
</html>